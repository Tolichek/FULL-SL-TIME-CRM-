<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Place CRM</title>
    <style>
        :root { --bg: #131314; --card: #1e1f20; --text: #e3e3e3; --acc: #8ab4f8; --sel: #4caf50; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: Roboto, sans-serif; overflow: hidden; }
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 10; }
        .active { display: flex !important; }

        /* Splash */
        #splash-screen { display: flex; align-items: center; justify-content: center; background: var(--bg); z-index: 20000; }

        /* LIST & ITEMS */
        .header { height: 60px; display: flex; align-items: center; padding: 0 15px; font-size: 20px; font-weight: 500; }
        .chat-list { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .chat-item { display: flex; padding: 12px 15px; align-items: center; position: relative; user-select: none; }
        .avatar-box { position: relative; width: 52px; height: 52px; margin-right: 15px; cursor: pointer; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; background: #3c4043; display: flex; align-items: center; justify-content: center; font-size: 20px; background-size: cover; background-position: center; }

        /* PROFILE (DESIGN FROM VIDEO) */
        #profile-screen { background: var(--bg); overflow-y: auto; }
        .profile-hero { width: 100%; height: 350px; background-size: cover; background-position: center; position: relative; background-color: #2a2e3a; }
        .profile-hero::after { content: ''; position: absolute; inset: 0; background: linear-gradient(transparent, rgba(19,19,20,0.9)); }
        .hero-top { position: absolute; top: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; z-index: 100; box-sizing: border-box; }
        .hero-info { position: absolute; bottom: 20px; left: 20px; z-index: 100; }
        
        .info-card { background: var(--card); border-radius: 15px; padding: 15px; margin: 10px 20px; display: flex; flex-direction: column; gap: 5px; }
        .info-label { font-size: 12px; color: var(--acc); font-weight: bold; }
        
        /* EDIT INPUTS - NO WHITE BORDER */
        .edit-input { width: 100%; background: none; border: none; border-bottom: 1px solid #333; color: white; padding: 12px 0; font-size: 18px; outline: none; }
        .edit-input:focus { border-bottom: 2px solid var(--acc); }

        .nav-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: var(--card); height: 65px; border-radius: 20px; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { color: #888; font-size: 11px; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--acc); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: var(--acc); border-radius: 18px; color: #131314; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="splash-screen" class="screen active"><div style="font-size:32px; letter-spacing:8px;">MY PLACE</div></div>

    <div id="list-screen" class="screen">
        <div class="header">My Place</div>
        <div id="chat-list" class="chat-list"></div>
        <div class="fab" onclick="openNew()">+</div>
        <div class="nav-bar">
            <div class="nav-item active" onclick="setF('all', this)">üë§ –í—Å—ñ</div>
            <div class="nav-item" onclick="setF('client', this)">üõí –ö–ª—ñ—î–Ω—Ç–∏</div>
            <div class="nav-item" onclick="setF('partner', this)">ü§ù –ö–æ–º–∞–Ω–¥–∞</div>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <div class="profile-hero" id="hero-img">
            <div class="hero-top">
                <svg onclick="goBack()" viewBox="0 0 24 24" style="fill:white; width:28px;"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"/></svg>
                <svg onclick="openEdit(curId)" viewBox="0 0 24 24" style="fill:white; width:24px;"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/></svg>
            </div>
            <div class="hero-info">
                <p style="font-size:28px; font-weight:bold; margin:0;" id="hero-name"></p>
                <p style="font-size:14px; opacity:0.6;">–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å ‚Äî –∑–∞—Ä–∞–∑</p>
            </div>
        </div>
        <div id="profile-info-list"></div>
    </div>

    <div id="edit-screen" class="screen">
        <div class="header">
            <span onclick="goBack()" style="margin-right:15px; cursor:pointer">‚Üê</span>
            <span style="flex:1">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span>
            <span onclick="saveContact()" style="color:var(--acc); font-weight:bold; cursor:pointer">–ó–ë–ï–†–ï–ì–¢–ò</span>
        </div>
        <div style="padding:20px; overflow-y:auto;">
            <div id="edit-img-btn" class="avatar" style="width:120px; height:120px; margin:0 auto 20px; cursor:pointer;">?</div>
            <input type="file" id="file-in" style="display:none" accept="image/*">
            <input type="text" id="in-ln" class="edit-input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ">
            <input type="text" id="in-fn" class="edit-input" placeholder="–Ü–º'—è">
            <input type="tel" id="in-tel" class="edit-input" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É">
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const cfg = { apiKey: "AIzaSyBLi2NoAigr1CDQm98iZHUZXNeDzJMwwxY", authDomain: "starlife-crm.firebaseapp.com", projectId: "starlife-crm", storageBucket: "starlife-crm.firebasestorage.app", messagingSenderId: "1022280682130", appId: "1:1022280682130:web:3ea517e8b6d22c7787744b" };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let clients = [], curId = null, filter = 'all', tempImg = "";

    const switchS = (id, push = true) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(push) history.pushState({screen: id}, "");
    };

    window.onpopstate = (e) => {
        if(e.state && e.state.screen) switchS(e.state.screen, false);
        else switchS('list-screen', false);
    };

    onAuthStateChanged(auth, u => {
        if(u) {
            onSnapshot(doc(db, "users", u.uid), d => {
                clients = d.exists() ? d.data().clients || [] : [];
                render();
                document.getElementById('splash-screen').style.display='none';
                if(!curId) switchS('list-screen');
            });
        } else signInWithPopup(auth, new GoogleAuthProvider());
    });

    window.render = () => {
        const b = document.getElementById('chat-list');
        let f = clients.filter(c => filter === 'all' || (filter === 'client' && c.isClient) || (filter === 'partner' && c.isPartner));
        b.innerHTML = f.map(c => `
            <div class="chat-item" onclick="openProfile(${c.id})">
                <div class="avatar-box">
                    <div class="avatar" style="${c.img?`background-image:url(${c.img})`:''}">${c.img?'':(c.ln?.[0]||'?')}</div>
                </div>
                <b>${c.ln||''} ${c.fn||''}</b>
            </div>
        `).join('');
    };

    window.openProfile = id => {
        curId = id;
        const c = clients.find(x => x.id == id);
        document.getElementById('hero-name').innerText = `${c.ln||''} ${c.fn||''}`;
        document.getElementById('hero-img').style.backgroundImage = c.img ? `url(${c.img})` : 'none';
        document.getElementById('profile-info-list').innerHTML = `
            <div class="info-card"><span class="info-label">–ú–æ–±—ñ–ª—å–Ω–∏–π</span><span style="font-size:17px">${c.tel || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</span></div>
        `;
        switchS('profile-screen');
    };

    window.openEdit = id => {
        const c = clients.find(x => x.id == id) || {};
        document.getElementById('in-ln').value = c.ln || '';
        document.getElementById('in-fn').value = c.fn || '';
        document.getElementById('in-tel').value = c.tel || '';
        tempImg = c.img || "";
        document.getElementById('edit-img-btn').style.backgroundImage = tempImg ? `url(${tempImg})` : 'none';
        document.getElementById('edit-img-btn').innerText = tempImg ? '' : '?';
        switchS('edit-screen');
    };

    window.openNew = () => { curId = null; openEdit(null); };

    window.saveContact = async () => {
        const ln = document.getElementById('in-ln').value;
        const fn = document.getElementById('in-fn').value;
        const tel = document.getElementById('in-tel').value;
        
        const contact = { id: curId || Date.now(), ln, fn, tel, img: tempImg, notes: [], isClient: filter==='client', isPartner: filter==='partner' };
        
        if(!curId) clients.push(contact);
        else clients[clients.findIndex(x => x.id == curId)] = {...clients.find(x => x.id == curId), ...contact};
        
        await setDoc(doc(db, "users", auth.currentUser.uid), { clients });
        switchS('list-screen');
    };

    document.getElementById('edit-img-btn').onclick = () => document.getElementById('file-in').click();
    document.getElementById('file-in').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { tempImg = ev.target.result; document.getElementById('edit-img-btn').style.backgroundImage = `url(${tempImg})`; document.getElementById('edit-img-btn').innerText = ''; };
        r.readAsDataURL(e.target.files[0]);
    };

    window.goBack = () => history.back();
    window.setF = (v, el) => {
        filter = v;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        render();
    };
</script>
</body>
</html>
