<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Place CRM</title>
    <style>
        :root { --bg: #131314; --card: #1e1f20; --text: #e3e3e3; --acc: #8ab4f8; --sel: #4caf50; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: Roboto, sans-serif; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 10; }
        .active { display: flex !important; }

        /* Splash Screen */
        #splash-screen { display: flex; align-items: center; justify-content: center; background: var(--bg); z-index: 20000; }
        .splash-logo { font-size: 32px; letter-spacing: 8px; text-transform: uppercase; color: white; font-weight: 300; }

        /* Action Bar (Multi-selection) */
        .action-bar { display: none; height: 60px; background: var(--bg); align-items: center; padding: 0 15px; gap: 20px; position: absolute; top: 0; left: 0; right: 0; z-index: 5000; }
        .action-bar.active { display: flex; }
        .action-bar svg { fill: white; width: 24px; height: 24px; cursor: pointer; }

        /* Lists */
        .header { height: 60px; display: flex; align-items: center; padding: 0 15px; font-size: 20px; font-weight: 500; }
        .chat-list { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .chat-item { display: flex; padding: 12px 15px; align-items: center; position: relative; }
        .avatar-box { position: relative; width: 52px; height: 52px; margin-right: 15px; flex-shrink: 0; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; background: #3c4043; display: flex; align-items: center; justify-content: center; font-size: 20px; background-size: cover; background-position: center; }
        .check-badge { position: absolute; bottom: -2px; right: -2px; width: 22px; height: 22px; background: var(--sel); border-radius: 50%; display: none; align-items: center; justify-content: center; border: 2px solid var(--bg); color: white; font-size: 10px; }
        .selected .check-badge { display: flex; }

        /* Chat Inside */
        .notes-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .note-bubble { background: #2b2c2f; padding: 10px 14px; border-radius: 18px; max-width: 80%; align-self: flex-start; }
        .input-area { background: var(--card); margin: 10px 15px 25px; border-radius: 25px; padding: 5px 15px; display: flex; align-items: center; gap: 10px; }
        .input-area textarea { flex: 1; background: transparent; border: none; color: white; outline: none; padding: 10px 0; font-size: 16px; resize: none; }

        /* Profile Parallax View */
        .profile-hero { width: 100%; height: 350px; background-size: cover; background-position: center; position: relative; background-color: #2a2e3a; }
        .profile-hero::after { content: ''; position: absolute; inset: 0; background: linear-gradient(transparent, rgba(19,19,20,1)); }
        .hero-top { position: absolute; top: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; z-index: 100; box-sizing: border-box; }
        .hero-info { position: absolute; bottom: 20px; left: 20px; z-index: 100; }
        
        .info-card { background: var(--card); border-radius: 15px; padding: 15px; margin: 10px 20px; }
        .action-buttons { display: flex; justify-content: space-around; padding: 15px 0; }
        .act-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 11px; color: var(--acc); cursor: pointer; }
        .act-icon { width: 45px; height: 45px; border-radius: 50%; background: var(--card); display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* Nav & FAB */
        .nav-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: var(--card); height: 65px; border-radius: 20px; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-item { color: #888; font-size: 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--acc); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: var(--acc); border-radius: 18px; color: #131314; display: flex; align-items: center; justify-content: center; font-size: 30px; z-index: 900; }

        /* Edit Inputs */
        .edit-input { width: 100%; background: none; border: none; border-bottom: 1px solid #333; color: white; padding: 15px 0; font-size: 18px; outline: none; }
        .edit-input:focus { border-bottom: 2px solid var(--acc); }
    </style>
</head>
<body>

    <div id="splash-screen" class="screen active"><div class="splash-logo">MY PLACE</div></div>

    <div id="bar-sel" class="action-bar">
        <svg onclick="resetSel()" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg>
        <div id="sel-count" class="sel-count" style="flex:1; font-size:20px; margin-left:20px;">0</div>
        <svg onclick="deleteItems()" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
    </div>

    <div id="screen-main" class="screen">
        <div class="header">–ö–æ–Ω—Ç–∞–∫—Ç–∏</div>
        <div id="contact-list" class="chat-list"></div>
        <div class="fab" onclick="openEdit(null)">+</div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="profile-hero" id="prof-hero-img">
            <div class="hero-top">
                <svg onclick="goBack()" viewBox="0 0 24 24" style="fill:white; width:28px;"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"/></svg>
                <svg onclick="openEdit(curId)" viewBox="0 0 24 24" style="fill:white; width:24px;"><path d="M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/></svg>
            </div>
            <div class="hero-info">
                <h2 id="prof-name" style="margin:0"></h2>
            </div>
        </div>
        <div class="action-buttons">
            <div class="act-btn" onclick="openChat(curId)"><div class="act-icon">üí¨</div>–ù–∞–ø–∏—Å–∞—Ç–∏</div>
            <div class="act-btn"><div class="act-icon">üîî</div>–í–∏–º–∫–Ω—É—Ç–∏</div>
            <div class="act-btn"><div class="act-icon">üìû</div>–í–∏–∫–ª–∏–∫</div>
        </div>
        <div id="prof-body"></div>
    </div>

    <div id="screen-chat" class="screen">
        <div class="header">
            <span onclick="goBack()" style="margin-right:20px;">‚Üê</span>
            <div id="chat-ava-head" class="avatar" style="width:36px; height:36px; margin-right:12px;"></div>
            <span id="chat-name-head" style="flex:1">–ß–∞—Ç</span>
        </div>
        <div id="notes-area" class="notes-area"></div>
        <div class="input-area">
            <textarea id="note-in" rows="1" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."></textarea>
            <button onclick="addNote()" style="background:none; border:none; color:var(--acc); font-weight:bold;">–û–ö</button>
        </div>
    </div>

    <div id="screen-my-profile" class="screen">
        <div class="header">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</div>
        <div style="padding:20px; text-align:center;">
            <div id="my-avatar" class="avatar" style="width:100px; height:100px; margin:0 auto 20px;"></div>
            <h3 id="my-name">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</h3>
            <div class="info-card" onclick="signOutUser()" style="color:#ff6b6b; font-weight:bold; cursor:pointer; padding:15px;">–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</div>
        </div>
    </div>

    <div id="screen-edit" class="screen">
        <div class="header">
            <span onclick="goBack()" style="margin-right:20px;">‚Üê</span>
            <span style="flex:1">–ö–æ–Ω—Ç–∞–∫—Ç</span>
            <span onclick="saveData()" style="color:var(--acc); font-weight:bold; cursor:pointer">–ì–û–¢–û–í–û</span>
        </div>
        <div style="padding:20px;">
            <div id="edit-avatar-btn" class="avatar" style="width:120px; height:120px; margin:0 auto 20px; cursor:pointer;">?</div>
            <input type="file" id="file-in" style="display:none" accept="image/*">
            <input type="text" id="in-ln" class="edit-input" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ">
            <input type="text" id="in-fn" class="edit-input" placeholder="–Ü–º'—è">
            <input type="tel" id="in-tel" class="edit-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="setMode('all', this)">üë§ –ö–æ–Ω—Ç–∞–∫—Ç–∏</div>
        <div class="nav-item" onclick="setMode('partner', this)">ü§ù –ö–æ–º–∞–Ω–¥–∞</div>
        <div class="nav-item" onclick="setMode('client', this)">üõí –ö–ª—ñ—î–Ω—Ç–∏</div>
        <div class="nav-item" onclick="switchS('screen-my-profile')">üÜî –ü—Ä–æ—Ñ—ñ–ª—å</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const cfg = { apiKey: "AIzaSyBLi2NoAigr1CDQm98iZHUZXNeDzJMwwxY", authDomain: "starlife-crm.firebaseapp.com", projectId: "starlife-crm", storageBucket: "starlife-crm.firebasestorage.app", messagingSenderId: "1022280682130", appId: "1:1022280682130:web:3ea517e8b6d22c7787744b" };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let clients = [], curId = null, mode = 'all', selC = new Set(), tempImg = "", hold;

    const switchS = (id, push = true) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(push) history.pushState({screen: id}, "");
    };

    window.onpopstate = (e) => switchS(e.state?.screen || 'screen-main', false);

    onAuthStateChanged(auth, u => {
        if(u) {
            document.getElementById('my-name').innerText = u.displayName;
            document.getElementById('my-avatar').style.backgroundImage = `url(${u.photoURL})`;
            onSnapshot(doc(db, "users", u.uid), d => {
                clients = d.exists() ? d.data().clients || [] : [];
                render();
                document.getElementById('splash-screen').style.display='none';
                if(!history.state) switchS('screen-main');
            });
        } else signInWithPopup(auth, new GoogleAuthProvider());
    });

    const render = () => {
        const b = document.getElementById('contact-list');
        let f = clients.filter(c => mode === 'all' || (mode === 'client' && c.isClient) || (mode === 'partner' && c.isPartner));
        b.innerHTML = f.map(c => `
            <div class="chat-item ${selC.has(c.id)?'selected':''}" data-id="${c.id}" onclick="handleTap(${c.id})">
                <div class="avatar-box">
                    <div class="avatar" style="${c.img?`background-image:url(${c.img})`:''}">${c.img?'':(c.ln?.[0]||'?')}</div>
                    <div class="check-badge">‚úì</div>
                </div>
                <div style="flex:1"><b>${c.ln||''} ${c.fn||''}</b></div>
            </div>
        `).join('');

        document.querySelectorAll('.chat-item').forEach(el => {
            const id = parseInt(el.dataset.id);
            el.onmousedown = el.ontouchstart = () => hold = setTimeout(() => toggleC(id), 600);
            el.onmouseup = el.ontouchend = () => clearTimeout(hold);
        });
    };

    window.handleTap = id => selC.size > 0 ? toggleC(id) : openProf(id);

    window.openProf = id => {
        curId = id; const c = clients.find(x => x.id == id);
        document.getElementById('prof-name').innerText = `${c.ln||''} ${c.fn||''}`;
        document.getElementById('prof-hero-img').style.backgroundImage = c.img ? `url(${c.img})` : 'none';
        document.getElementById('prof-body').innerHTML = `<div class="info-card"><span style="color:var(--acc); font-size:12px; font-weight:bold;">–¢–µ–ª–µ—Ñ–æ–Ω</span><br><span>${c.tel||'‚Äî'}</span></div>`;
        switchS('screen-profile');
    };

    window.openChat = id => {
        curId = id; const c = clients.find(x => x.id == id);
        document.getElementById('chat-name-head').innerText = `${c.ln||''} ${c.fn||''}`;
        document.getElementById('chat-ava-head').style.backgroundImage = c.img ? `url(${c.img})` : 'none';
        renderNotes(); switchS('screen-chat');
    };

    window.renderNotes = () => {
        const c = clients.find(x => x.id == curId);
        document.getElementById('notes-area').innerHTML = (c.notes || []).map(n => `<div class="note-bubble">${n.text}</div>`).join('');
    };

    window.addNote = async () => {
        const i = document.getElementById('note-in');
        if(!i.value.trim()) return;
        clients.find(x => x.id == curId).notes.push({ text: i.value });
        i.value = ''; await setDoc(doc(db, "users", auth.currentUser.uid), { clients });
        renderNotes();
    };

    window.saveData = async () => {
        const ln = document.getElementById('in-ln').value, fn = document.getElementById('in-fn').value;
        const data = { id: curId || Date.now(), ln, fn, tel: document.getElementById('in-tel').value, img: tempImg, isClient: mode==='client', isPartner: mode==='partner', notes: curId ? (clients.find(x => x.id == curId).notes || []) : [] };
        if(!curId) clients.push(data); else clients[clients.findIndex(x => x.id == curId)] = data;
        await setDoc(doc(db, "users", auth.currentUser.uid), { clients });
        goBack();
    };

    window.openEdit = id => {
        curId = id; const c = id ? clients.find(x => x.id == id) : {};
        document.getElementById('in-ln').value = c.ln || ''; document.getElementById('in-fn').value = c.fn || ''; document.getElementById('in-tel').value = c.tel || '';
        tempImg = c.img || ""; const av = document.getElementById('edit-avatar-btn');
        av.style.backgroundImage = tempImg ? `url(${tempImg})` : 'none'; av.innerText = tempImg ? '' : '?';
        switchS('screen-edit');
    };

    window.setMode = (m, el) => {
        mode = m; document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); el.classList.add('active');
        render(); switchS('screen-main');
    };

    const toggleC = id => {
        selC.has(id) ? selC.delete(id) : selC.add(id);
        document.getElementById('bar-sel').classList.toggle('active', selC.size > 0);
        document.getElementById('sel-count').innerText = selC.size;
        render();
    };

    window.resetSel = () => { selC.clear(); document.getElementById('bar-sel').classList.remove('active'); render(); };
    window.deleteItems = async () => { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")) { clients = clients.filter(c => !selC.has(c.id)); await setDoc(doc(db, "users", auth.currentUser.uid), { clients }); resetSel(); } };
    window.signOutUser = () => signOut(auth).then(() => location.reload());
    window.goBack = () => history.back();

    document.getElementById('edit-avatar-btn').onclick = () => document.getElementById('file-in').click();
    document.getElementById('file-in').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { tempImg = ev.target.result; document.getElementById('edit-avatar-btn').style.backgroundImage = `url(${tempImg})`; document.getElementById('edit-avatar-btn').innerText = ''; };
        r.readAsDataURL(e.target.files[0]);
    };
</script>
</body>
</html>