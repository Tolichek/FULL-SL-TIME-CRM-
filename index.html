<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Place CRM</title>
    <style>
        :root { --bg: #131314; --card: #1e1f20; --text: #e3e3e3; --acc: #8ab4f8; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: Roboto, sans-serif; overflow: hidden; }
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--bg); }
        .active { display: flex !important; }
        
        /* Login */
        #login-screen { align-items: center; justify-content: center; z-index: 100; }
        .google-btn { background: white; color: black; padding: 15px 30px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        /* Main UI */
        .header { background: var(--card); padding: 10px 15px; display: flex; align-items: center; border-bottom: 1px solid #333; }
        .chat-list { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .chat-item { display: flex; padding: 12px 15px; align-items: center; border-bottom: 1px solid #282828; cursor: pointer; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #3c4043; margin-right: 12px; background-size: cover; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        
        /* Chat */
        .notes-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #0b0b0b; }
        .note-bubble { background: #2b2c2f; padding: 10px; border-radius: 15px; max-width: 85%; align-self: flex-start; position: relative; }
        .note-time { font-size: 10px; opacity: 0.5; float: right; margin-top: 5px; margin-left: 8px; }
        .input-bar { background: var(--card); padding: 10px; display: flex; gap: 10px; border-top: 1px solid #333; }
        .input-bar textarea { flex: 1; border: none; background: #2b2c2f; padding: 10px; border-radius: 15px; color: white; resize: none; outline: none; }
        
        /* Nav */
        .nav-bar { position: fixed; bottom: 15px; left: 10px; right: 10px; background: var(--card); height: 60px; border-radius: 20px; display: flex; justify-content: space-around; align-items: center; border: 1px solid #333; z-index: 1000; }
        .nav-item { color: #b4b4b4; font-size: 11px; cursor: pointer; text-align: center; }
        .active-nav { color: var(--acc); }
        
        /* Edit */
        .profile-top { display: flex; align-items: center; gap: 15px; padding: 20px; }
        .edit-inputs { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .edit-inputs input { background: transparent; border: none; border-bottom: 1px solid #333; color: white; padding: 5px; outline: none; }
        .card-box { background: var(--card); margin: 10px; padding: 15px; border-radius: 12px; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        
        .fab { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: var(--acc); border-radius: 15px; color: #131314; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; z-index: 500; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1 style="color: var(--acc); font-size: 42px; margin-bottom: 30px;">My Place</h1>
        <button class="google-btn" id="btn-login">–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    </div>

    <div id="list-screen" class="screen">
        <div class="header"><b id="list-title">My Place</b></div>
        <div id="chat-list" class="chat-list"></div>
        <div class="fab" id="btn-add">+</div>
    </div>

    <div id="profile-screen" class="screen">
        <div class="header"><b>–ü—Ä–æ—Ñ—ñ–ª—å</b></div>
        <div class="card-box" style="text-align: center;">
            <div id="user-avatar" class="avatar" style="width:80px; height:80px; margin: 0 auto 15px;">?</div>
            <h2 id="user-name">–ì—ñ—Å—Ç—å</h2>
            <p id="user-email" style="color: #888;"></p>
            <button id="btn-logout" style="background: none; border: 1px solid #ff6b6b; color: #ff6b6b; padding: 8px 20px; border-radius: 10px; margin-top: 20px; cursor: pointer;">–í–∏–π—Ç–∏</button>
        </div>
    </div>

    <div id="chat-screen" class="screen">
        <div class="header">
            <div id="chat-back" style="cursor:pointer; font-size:24px; margin-right:15px;">‚Üê</div>
            <div id="chat-avatar" class="avatar" style="width:35px; height:35px; margin:0; margin-right:10px;"></div>
            <div id="chat-name" style="font-weight:500;"></div>
        </div>
        <div id="notes-area" class="notes-area"></div>
        <div class="input-bar">
            <textarea id="note-input" rows="1"></textarea>
            <button id="btn-send" style="color:var(--acc); background:none; border:none; font-weight:bold;">–û–ö</button>
        </div>
    </div>

    <div id="edit-screen" class="screen">
        <div class="header">
            <div id="edit-back" style="cursor:pointer; font-size:24px; margin-right:15px;">‚Üê</div>
            <div style="flex:1;">–ö–æ–Ω—Ç–∞–∫—Ç</div>
            <div id="btn-save" style="color:var(--acc); font-weight:bold; cursor:pointer;">–ì–û–¢–û–í–û</div>
        </div>
        <div class="profile-top">
            <div id="edit-img" class="avatar" style="width:70px; height:70px; margin:0;">?</div>
            <div class="edit-inputs">
                <input type="text" id="in-ln" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ">
                <input type="text" id="in-fn" placeholder="–Ü–º'—è">
            </div>
        </div>
        <div class="card-box">
            <div class="row"><span>–ü–∞—Ä—Ç–Ω–µ—Ä</span><input type="checkbox" id="chk-p"></div>
            <div class="row"><span>–ö–ª—ñ—î–Ω—Ç</span><input type="checkbox" id="chk-c"></div>
        </div>
    </div>

    <div class="nav-bar" id="bottom-nav" style="display:none;">
        <div class="nav-item active-nav" id="f-all">üë§ –í—Å—ñ</div>
        <div class="nav-item" id="f-client">üõí –ö–ª—ñ—î–Ω—Ç–∏</div>
        <div class="nav-item" id="f-partner">ü§ù –ö–æ–º–∞–Ω–¥–∞</div>
        <div class="nav-item" id="f-profile">üÜî –ü—Ä–æ—Ñ—ñ–ª—å</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const cfg = {
        apiKey: "AIzaSyBLi2NoAigr1CDQm98iZHUZXNeDzJMwwxY",
        authDomain: "starlife-crm.firebaseapp.com",
        projectId: "starlife-crm",
        storageBucket: "starlife-crm.firebasestorage.app",
        messagingSenderId: "1022280682130",
        appId: "1:1022280682130:web:3ea517e8b6d22c7787744b"
    };

    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const prov = new GoogleAuthProvider();

    let clients = [], curId = null, isNew = false, filter = 'all';

    onAuthStateChanged(auth, u => {
        if(u) {
            document.getElementById('user-name').innerText = u.displayName;
            document.getElementById('user-email').innerText = u.email;
            document.getElementById('user-avatar').style.backgroundImage = `url(${u.photoURL})`;
            switchScreen('list-screen'); 
            sub(u.uid); 
        } else { 
            switchScreen('login-screen'); 
        }
    });

    const sub = uid => onSnapshot(doc(db, "users", uid), d => {
        clients = d.exists() ? d.data().clients : [];
        render();
        if(curId) updateChat();
    });

    const upd = async () => await setDoc(doc(db, "users", auth.currentUser.uid), { clients });

    const render = () => {
        const b = document.getElementById('chat-list'); b.innerHTML = '';
        let f = clients;
        if(filter === 'client') f = clients.filter(c => c.isClient && !c.isPartner);
        if(filter === 'partner') f = clients.filter(c => c.isPartner);
        
        f.forEach(c => {
            const d = document.createElement('div'); d.className = 'chat-item';
            d.innerHTML = `<div class="avatar">${c.ln[0]}</div><b>${c.ln} ${c.fn}</b>`;
            d.onclick = () => { curId = c.id; updateChat(); switchScreen('chat-screen'); };
            b.appendChild(d);
        });
    };

    const updateChat = () => {
        const c = clients.find(x => x.id == curId); if(!c) return;
        document.getElementById('chat-name').innerText = `${c.ln} ${c.fn}`;
        document.getElementById('chat-avatar').innerText = c.ln[0];
        document.getElementById('notes-area').innerHTML = c.notes.map(n => `<div class="note-bubble">${n.text}<span class="note-time">${n.time}</span></div>`).join('');
    };

    const switchScreen = id => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('bottom-nav').style.display = (id === 'list-screen' || id === 'profile-screen') ? 'flex' : 'none';
    };

    document.getElementById('btn-login').onclick = () => signInWithPopup(auth, prov);
    document.getElementById('btn-logout').onclick = () => signOut(auth);
    document.getElementById('btn-add').onclick = () => { isNew = true; curId = null; switchScreen('edit-screen'); };
    document.getElementById('chat-back').onclick = () => switchScreen('list-screen');
    document.getElementById('edit-back').onclick = () => isNew ? switchScreen('list-screen') : switchScreen('chat-screen');

    document.getElementById('btn-save').onclick = async () => {
        const ln = document.getElementById('in-ln').value, fn = document.getElementById('in-fn').value;
        if(!ln || !fn) return;
        const d = { ln, fn, isPartner: document.getElementById('chk-p').checked, isClient: document.getElementById('chk-c').checked };
        if(isNew) { curId = Date.now(); clients.push({ id: curId, ...d, notes: [] }); }
        else { const i = clients.findIndex(x => x.id == curId); clients[i] = {...clients[i], ...d}; }
        await upd(); switchScreen('chat-screen');
    };

    document.getElementById('btn-send').onclick = async () => {
        const i = document.getElementById('note-input'); if(!i.value) return;
        const c = clients.find(x => x.id == curId);
        const now = new Date();
        c.notes.push({ text: i.value, time: now.getHours()+':'+(now.getMinutes()<10?'0':'')+now.getMinutes() });
        i.value = ''; await upd();
    };

    document.querySelectorAll('.nav-item').forEach(n => n.onclick = () => {
        const type = n.id.split('-')[1];
        if(type === 'profile') { switchScreen('profile-screen'); }
        else { filter = type; switchScreen('list-screen'); render(); }
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active-nav'));
        n.classList.add('active-nav');
    });
</script>
</body>
</html>
